---
- name: secrets file exists at /root/karakeep/.env
  ansible.builtin.stat:
    path: "{{ karakeep_secrets_file }}"
  register: _secrets_file

- name: fail if secrets file is missing
  ansible.builtin.fail:
    msg: >
      The secrets file is missing at {{ karakeep_secrets_file }}.
      Please create it manually with MEILI_MASTER_KEY, NEXTAUTH_SECRET, and OPENAI_API_KEY.
  when: not _secrets_file.stat.exists

- name: karakeep install directory exists
  ansible.builtin.file:
    path: "{{ karakeep_install_dir }}"
    state: directory
    mode: 0755

- name: karakeep docker-compose file is templated
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ karakeep_install_dir }}/docker-compose.yml"
    mode: 0640

- name: karakeep data directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: 0755
  loop:
    - "{{ karakeep_data_root }}/karakeep_data"
    - "{{ karakeep_data_root }}/meilisearch_data"

- name: karakeep stack is running
  community.docker.docker_compose_v2:
    project_src: "{{ karakeep_install_dir }}"
    state: present
    pull: always
