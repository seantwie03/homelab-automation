---
- name: Ensure 1password repository is configured
  block:
    - name: Ensure 1Password repository key is installed
      ansible.builtin.rpm_key:
        key: https://downloads.1password.com/linux/keys/1password.asc
        state: present

    - name: Ensure 1Password repository is enabled
      ansible.builtin.yum_repository:
        name: 1password
        description: 1Password Stable Channel
        baseurl: https://downloads.1password.com/linux/rpm/stable/$basearch/
        enabled: true
        gpgcheck: true
        repo_gpgcheck: true
        gpgkey: https://downloads.1password.com/linux/keys/1password.asc

- name: Ensure 1password-cli is installed
  ansible.builtin.package:
    name: 1password-cli
    state: present

- name: Get default target
  ansible.builtin.stat:
    path: /etc/systemd/system/default.target
  register: default_target

- name: Print default systemd target
  ansible.builtin.debug:
    var: default_target.stat.lnk_target
    verbosity: 1

- name: Ensure 1password GUI is installed on graphical systems
  ansible.builtin.package:
    name: 1password
    state: present
  when: "'graphical' in default_target.stat.lnk_target"

- name: Ensure autostart directory exists
  ansible.builtin.file:
    path: /home/{{ gui_user }}/.config/autostart
    state: directory
    owner: "{{ gui_user }}"
    group: "{{ gui_user }}"
    mode: "0755"

- name: Ensure 1password GUI autostarts on graphical systems
  ansible.builtin.copy:
    remote_src: true
    src: /usr/share/applications/1password.desktop
    dest: /home/{{ gui_user }}/.config/autostart/1password.desktop
    owner: "{{ gui_user }}"
    group: "{{ gui_user }}"
    mode: "0644"
  when: "'graphical' in default_target.stat.lnk_target"
